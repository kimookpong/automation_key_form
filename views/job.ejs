<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Automation Key Form ‚Ä¢ ‡∏á‡∏≤‡∏ô</title>
  <link rel="stylesheet" href="/public/style.css" />
</head>
<body>
  <header>
    <div class="header-brand">
      <div class="header-logo">ü§ñ</div>
      <div class="header-text">
        <h1>Automation Key Form</h1>
        <span class="header-subtitle">‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</span>
      </div>
    </div>
    <nav>
      <a href="/" class="<%= (job.status === 'completed' || job.status === 'failed') ? 'nav-button active' : 'nav-button disabled' %>" 
         id="home-link"
         onclick="<%= (job.status === 'completed' || job.status === 'failed') ? '' : 'return false;' %>">
        <span class="nav-icon">üè†</span>
        <span class="nav-text">‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å</span>
      </a>
    </nav>
  </header>
  <main class="split-layout">
    <div class="left-panel">
<section class="card">
  <h2>‡∏á‡∏≤‡∏ô: <%= job.id %></h2>
  
  <!-- Row 1: Status, Start, End -->
  <div class="stats-row-1">
    <div class="stat-item">
      <div class="stat-label">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</div>
      <span id="status" class="badge <%= job.status %>"><%= job.status %></span>
    </div>
    <div class="stat-item">
      <div class="stat-label">‡πÄ‡∏£‡∏¥‡πà‡∏°</div>
      <div class="stat-value" id="startedAt"><%= job.startedAt || '-' %></div>
    </div>
    <div class="stat-item">
      <div class="stat-label">‡πÄ‡∏™‡∏£‡πá‡∏à</div>
      <div class="stat-value" id="endedAt"><%= job.endedAt || '-' %></div>
    </div>
  </div>
  
  <!-- Row 2: Cards with colors -->
  <div class="stats-cards">
    <div class="stat-card stat-card-blue">
      <div class="stat-card-icon">üìä</div>
      <div class="stat-card-value" id="total"><%= job.total %></div>
      <div class="stat-card-label">‡∏£‡∏ß‡∏°</div>
    </div>
    <div class="stat-card stat-card-yellow">
      <div class="stat-card-icon">‚öôÔ∏è</div>
      <div class="stat-card-value" id="processed"><%= job.processed %></div>
      <div class="stat-card-label">‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•</div>
    </div>
    <div class="stat-card stat-card-green">
      <div class="stat-card-icon">‚úÖ</div>
      <div class="stat-card-value" id="success"><%= job.success %></div>
      <div class="stat-card-label">‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</div>
    </div>
    <div class="stat-card stat-card-red">
      <div class="stat-card-icon">‚ùå</div>
      <div class="stat-card-value" id="failed"><%= job.failed %></div>
      <div class="stat-card-label">‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î</div>
    </div>
  </div>
  
  <progress id="progress" max="<%= job.total %>" value="<%= job.processed %>"></progress>
  
  <!-- Excel Data Display -->
  <% if (excelData && Array.isArray(excelData) && excelData.length > 0) { %>
  <% 
    // Check if data is array of objects or array of arrays
    const isArrayOfObjects = typeof excelData[0] === 'object' && !Array.isArray(excelData[0]);
    let headers = [];
    let dataRows = [];
    
    if (isArrayOfObjects) {
      // Array of objects format
      headers = excelData.length > 0 ? Object.keys(excelData[0]) : [];
      dataRows = excelData;
    } else {
      // Array of arrays format
      headers = Array.isArray(excelData[0]) ? excelData[0] : [];
      dataRows = excelData.slice(1);
    }
    
    const validRowCount = dataRows.length;
  %>
  <div style="margin-top: 20px; padding-top: 20px; border-top: 2px solid rgba(102, 126, 234, 0.2);">
    <h3>üìä ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Excel (<span id="excel-count"><%= validRowCount %></span> ‡πÅ‡∏ñ‡∏ß)</h3>
    <div style="overflow-x: auto; margin-top: 16px;">
      <table id="excel-table" class="display" style="width:100%">
        <thead>
          <tr>
            <% headers.forEach(header => { %>
              <th><%= header || '-' %></th>
            <% }); %>
          </tr>
        </thead>
        <tbody>
          <% if (isArrayOfObjects) { %>
            <% dataRows.forEach(row => { %>
              <tr>
                <% headers.forEach(header => { %>
                  <td><%= row[header] !== undefined ? row[header] : '-' %></td>
                <% }); %>
              </tr>
            <% }); %>
          <% } else { %>
            <% dataRows.forEach(row => { %>
              <tr>
                <% if (Array.isArray(row)) { %>
                  <% headers.forEach((_, index) => { %>
                    <td><%= row[index] !== undefined ? row[index] : '-' %></td>
                  <% }); %>
                <% } %>
              </tr>
            <% }); %>
          <% } %>
        </tbody>
      </table>
    </div>
  </div>
  <% } %>
 </section>

 <section class="card">
  <h3>‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏†‡∏≤‡∏û‡∏™‡∏î (Live Preview)</h3>
    <div class="live-preview">
      <img id="live-snap" src="" alt="live snapshot" />
      <div class="placeholder">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏≠‡∏†‡∏≤‡∏û‡∏™‡∏î...</div>
    </div>
</section>

<section class="card">
  <h3>‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏ï‡πà‡∏≠‡πÅ‡∏ñ‡∏ß</h3>
    <div style="overflow-x: auto;">
      <table id="results-table" class="display" style="width:100%">
        <thead>
          <tr>
            <th>#</th>
            <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
            <th>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</th>
            <th>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏/‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î</th>
          </tr>
        </thead>
        <tbody id="results"></tbody>
      </table>
    </div>
 </section>
    </div>

    <div class="right-panel">
 <section class="card log-section">
  <h3>Log</h3>
  <pre id="log" class="log"></pre>
</section>
    </div>

  </main>

  <script src="/public/app.js"></script>
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/jquery.dataTables.min.css">
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
  <style>
    /* DataTables custom styling */
    #excel-table_wrapper,
    #results-table_wrapper {
      padding: 0;
    }
    
    #excel-table_wrapper .dataTables_length,
    #excel-table_wrapper .dataTables_filter,
    #results-table_wrapper .dataTables_length,
    #results-table_wrapper .dataTables_filter {
      margin-bottom: 16px;
    }
    
    #excel-table_wrapper .dataTables_filter input,
    #results-table_wrapper .dataTables_filter input {
      padding: 8px 12px;
      border: 2px solid rgba(102, 126, 234, 0.2);
      border-radius: 8px;
      margin-left: 8px;
    }
    
    #excel-table_wrapper .dataTables_length select,
    #results-table_wrapper .dataTables_length select {
      padding: 6px 12px;
      border: 2px solid rgba(102, 126, 234, 0.2);
      border-radius: 8px;
      margin: 0 8px;
    }
    
    #excel-table_wrapper .dataTables_paginate,
    #results-table_wrapper .dataTables_paginate {
      margin-top: 16px;
    }
    
    #excel-table_wrapper .dataTables_paginate .paginate_button,
    #results-table_wrapper .dataTables_paginate .paginate_button {
      padding: 6px 12px;
      margin: 0 4px;
      border-radius: 6px;
      border: 1px solid rgba(102, 126, 234, 0.2);
      background: rgba(255, 255, 255, 0.9);
      cursor: pointer;
    }
    
    #excel-table_wrapper .dataTables_paginate .paginate_button.current,
    #results-table_wrapper .dataTables_paginate .paginate_button.current {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white !important;
      border: none;
    }
    
    #excel-table_wrapper .dataTables_paginate .paginate_button:hover:not(.current),
    #results-table_wrapper .dataTables_paginate .paginate_button:hover:not(.current) {
      background: rgba(102, 126, 234, 0.1);
    }
    
    #excel-table_wrapper .dataTables_info,
    #results-table_wrapper .dataTables_info {
      padding-top: 16px;
      color: #6b7280;
      font-size: 14px;
    }
  </style>
  <script>
  window.setupJobDetail && window.setupJobDetail('<%= job.id %>');
  
  // Initialize DataTable for Excel data
  <% if (excelData && Array.isArray(excelData) && excelData.length > 0) { %>
  $(document).ready(function() {
    $('#excel-table').DataTable({
      pageLength: 10,
      lengthMenu: [[10, 25, 50, 100, -1], [10, 25, 50, 100, "‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î"]],
      language: {
        search: "‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤:",
        lengthMenu: "‡πÅ‡∏™‡∏î‡∏á _MENU_ ‡πÅ‡∏ñ‡∏ß‡∏ï‡πà‡∏≠‡∏´‡∏ô‡πâ‡∏≤",
        info: "‡πÅ‡∏™‡∏î‡∏á _START_ ‡∏ñ‡∏∂‡∏á _END_ ‡∏à‡∏≤‡∏Å _TOTAL_ ‡πÅ‡∏ñ‡∏ß",
        infoEmpty: "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•",
        infoFiltered: "(‡∏Å‡∏£‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î _MAX_ ‡πÅ‡∏ñ‡∏ß)",
        paginate: {
          first: "‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å",
          last: "‡∏´‡∏ô‡πâ‡∏≤‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢",
          next: "‡∏ñ‡∏±‡∏î‡πÑ‡∏õ",
          previous: "‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤"
        },
        emptyTable: "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á",
        zeroRecords: "‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤"
      },
      order: [] // No initial sorting
    });
  });
  <% } %>
  
  // Initialize DataTable for Results table (make it global for app.js to access)
  $(document).ready(function() {
    window.resultsTable = $('#results-table').DataTable({
      pageLength: 10,
      lengthMenu: [[10, 25, 50, 100, -1], [10, 25, 50, 100, "‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î"]],
      language: {
        search: "‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤:",
        lengthMenu: "‡πÅ‡∏™‡∏î‡∏á _MENU_ ‡πÅ‡∏ñ‡∏ß‡∏ï‡πà‡∏≠‡∏´‡∏ô‡πâ‡∏≤",
        info: "‡πÅ‡∏™‡∏î‡∏á _START_ ‡∏ñ‡∏∂‡∏á _END_ ‡∏à‡∏≤‡∏Å _TOTAL_ ‡πÅ‡∏ñ‡∏ß",
        infoEmpty: "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•",
        infoFiltered: "(‡∏Å‡∏£‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î _MAX_ ‡πÅ‡∏ñ‡∏ß)",
        paginate: {
          first: "‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å",
          last: "‡∏´‡∏ô‡πâ‡∏≤‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢",
          next: "‡∏ñ‡∏±‡∏î‡πÑ‡∏õ",
          previous: "‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤"
        },
        emptyTable: "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á",
        zeroRecords: "‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤"
      },
      order: [[0, 'asc']], // Sort by row number
      columnDefs: [
        { orderable: true, targets: 0 } // Enable sorting on # column
      ]
    });
  });
  </script>
</body>
</html>
